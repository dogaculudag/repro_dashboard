generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  ONREPRO
  GRAFIKER
  KALITE
  KOLAJ
}

enum FileStatus {
  AWAITING_ASSIGNMENT
  ASSIGNED
  IN_REPRO
  APPROVAL_PREP
  CUSTOMER_APPROVAL
  REVISION_REQUIRED
  IN_QUALITY
  IN_KOLAJ
  SENT_TO_PRODUCTION
}

enum ActionType {
  CREATE
  ASSIGN
  TAKEOVER
  TRANSFER
  CUSTOMER_SENT
  CUSTOMER_OK
  CUSTOMER_NOK
  QUALITY_OK
  QUALITY_NOK
  RESTART_MG
  CLOSE
  OVERRIDE
  LOCATION_UPDATE
  NOTE_ADDED
  STATUS_CHANGE
  PRE_REPRO_CLAIMED
  PRE_REPRO_HANDED_OFF
  PRE_REPRO_RETURNED_TO_QUEUE
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum LocationArea {
  WAITING
  REPRO
  QUALITY
  KOLAJ
  ARCHIVE
}

enum Stage {
  PRE_REPRO
  REPRO
  PLOTTER_KONTROL
  COLLAGE
  DONE
}

// ============================================
// MODELS
// ============================================

model User {
  id            String   @id @default(uuid())
  username      String   @unique @db.VarChar(50)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  fullName      String   @map("full_name") @db.VarChar(100)
  email         String?  @unique @db.VarChar(255)
  role          Role
  departmentId  String   @map("department_id")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  department          Department  @relation(fields: [departmentId], references: [id])
  assignedFiles       File[]      @relation("AssignedDesigner")
  targetAssigneeFiles File[]      @relation("TargetAssignee")
  timers              Timer[]
  notes            Note[]
  auditLogs        AuditLog[]  @relation("ByUser")
  workSessions     WorkSession[]
  timeEntries      TimeEntry[]

  @@map("users")
  @@index([role])
  @@index([departmentId])
  @@index([isActive])
}

model Department {
  id         String   @id @default(uuid())
  name       String   @db.VarChar(100)
  code       String   @unique @db.VarChar(20)
  isVirtual  Boolean  @default(false) @map("is_virtual")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  users            User[]
  currentFiles     File[]        @relation("CurrentDepartment")
  timers           Timer[]
  notes            Note[]
  fromAuditLogs    AuditLog[]    @relation("FromDepartment")
  toAuditLogs      AuditLog[]    @relation("ToDepartment")
  slaTarget        SlaTarget?
  workSessions     WorkSession[]
  timeEntries      TimeEntry[]

  @@map("departments")
}

model FileType {
  id                      String   @id @default(uuid())
  name                    String   @unique @db.VarChar(100)
  description             String?  @db.VarChar(500)
  defaultDifficultyLevel  Int?     @map("default_difficulty_level")
  defaultDifficultyWeight Float?   @map("default_difficulty_weight")
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  files File[]

  @@map("file_types")
}

model WorkSession {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  fileId          String    @map("file_id")
  departmentId     String    @map("department_id")
  startTime       DateTime  @map("start_time")
  endTime         DateTime? @map("end_time")
  durationMinutes Int?      @map("duration_minutes")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  file       File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])

  @@map("work_sessions")
  @@index([userId])
  @@index([fileId])
  @@index([departmentId])
  @@index([startTime])
  @@index([endTime])
}

model LocationSlot {
  id        String       @id @default(uuid())
  code      String       @unique @db.VarChar(20)
  name      String       @db.VarChar(100)
  area      LocationArea
  row       Int
  column    Int
  isActive  Boolean      @default(true) @map("is_active")
  createdAt DateTime     @default(now()) @map("created_at")

  // Relations
  files File[]

  @@map("location_slots")
  @@index([area])
  @@index([isActive])
}

model File {
  id                    String     @id @default(uuid())
  fileNo                String     @unique @map("file_no") @db.VarChar(50)
  customerName          String     @map("customer_name") @db.VarChar(200)
  customerNo            String?    @map("customer_no") @db.VarChar(50)
  sapNumber             String?    @map("sap_number") @db.VarChar(50)
  orderName             String?    @map("order_name") @db.VarChar(200)
  designNo              String?    @map("design_no") @db.VarChar(50)
  revisionNo            String?    @map("revision_no") @db.VarChar(50)
  dueDate               DateTime?   @map("due_date")
  ksmData               Json?      @map("ksm_data") @db.JsonB
  ksmTechnicalData      Json?      @map("ksm_technical_data") @db.JsonB
  status                FileStatus @default(AWAITING_ASSIGNMENT)
  stage                 Stage?
  targetAssigneeId      String?    @map("target_assignee_id")
  assignedDesignerId    String?    @map("assigned_designer_id")
  currentDepartmentId   String     @map("current_department_id")
  currentLocationSlotId String?    @map("current_location_slot_id")
  fileTypeId            String?    @map("file_type_id")
  difficultyLevel       Int        @default(3) @map("difficulty_level")
  difficultyWeight      Float      @default(1.0) @map("difficulty_weight")
  iterationNumber       Int        @default(1) @map("iteration_number")
  iterationLabel        String     @default("MG1") @map("iteration_label") @db.VarChar(20)
  pendingTakeover       Boolean    @default(false) @map("pending_takeover")
  requiresApproval      Boolean    @default(true) @map("requires_approval")
  priority              Priority   @default(NORMAL)
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")
  closedAt              DateTime?  @map("closed_at")

  // Relations
  assignedDesigner    User?          @relation("AssignedDesigner", fields: [assignedDesignerId], references: [id])
  targetAssignee      User?          @relation("TargetAssignee", fields: [targetAssigneeId], references: [id])
  currentDepartment   Department    @relation("CurrentDepartment", fields: [currentDepartmentId], references: [id])
  currentLocationSlot LocationSlot? @relation(fields: [currentLocationSlotId], references: [id])
  fileType            FileType?      @relation(fields: [fileTypeId], references: [id])
  timers              Timer[]
  notes               Note[]
  auditLogs           AuditLog[]
  workSessions        WorkSession[]
  timeEntries         TimeEntry[]

  @@map("files")
  @@index([fileNo])
  @@index([status])
  @@index([stage])
  @@index([targetAssigneeId])
  @@index([assignedDesignerId])
  @@index([currentDepartmentId])
  @@index([fileTypeId])
  @@index([createdAt])
  @@index([pendingTakeover])
  @@index([customerName])
}

model TimeEntry {
  id              String    @id @default(uuid())
  fileId          String    @map("file_id")
  userId          String    @map("user_id")
  departmentId    String    @map("department_id")
  startAt         DateTime  @map("start_at")
  endAt           DateTime? @map("end_at")
  durationSeconds Int?      @map("duration_seconds")
  note            String?   @db.VarChar(500)
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  file       File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])

  @@map("time_entries")
  @@index([fileId])
  @@index([userId])
  @@index([departmentId])
  @@index([startAt])
  @@index([endAt])
}

model Timer {
  id              String    @id @default(uuid())
  fileId          String    @map("file_id")
  departmentId    String    @map("department_id")
  userId          String?   @map("user_id")
  startTime       DateTime  @map("start_time")
  endTime         DateTime? @map("end_time")
  durationSeconds Int?      @map("duration_seconds")
  reasonCode      String?   @map("reason_code") @db.VarChar(50)
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  file       File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])
  user       User?      @relation(fields: [userId], references: [id])

  @@map("timers")
  @@index([fileId])
  @@index([departmentId])
  @@index([userId])
  @@index([startTime])
  @@index([endTime])
}

model Note {
  id           String   @id @default(uuid())
  fileId       String   @map("file_id")
  userId       String   @map("user_id")
  departmentId String   @map("department_id")
  message      String   @db.Text
  isSystem     Boolean  @default(false) @map("is_system")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  file       File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])

  @@map("notes")
  @@index([fileId])
  @@index([createdAt])
}

model AuditLog {
  id               String     @id @default(uuid())
  fileId           String     @map("file_id")
  actionType       ActionType @map("action_type")
  fromDepartmentId String?    @map("from_department_id")
  toDepartmentId   String?    @map("to_department_id")
  byUserId         String     @map("by_user_id")
  payload          Json?      @db.JsonB
  timestamp        DateTime   @default(now())
  ipAddress        String?    @map("ip_address") @db.VarChar(45)

  // Relations
  file           File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fromDepartment Department? @relation("FromDepartment", fields: [fromDepartmentId], references: [id])
  toDepartment   Department? @relation("ToDepartment", fields: [toDepartmentId], references: [id])
  byUser         User        @relation("ByUser", fields: [byUserId], references: [id])

  @@map("audit_logs")
  @@index([fileId])
  @@index([actionType])
  @@index([timestamp])
  @@index([byUserId])
}

model SlaTarget {
  id            String   @id @default(uuid())
  departmentId  String   @unique @map("department_id")
  warningHours  Int      @map("warning_hours")
  criticalHours Int      @map("critical_hours")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  department Department @relation(fields: [departmentId], references: [id])

  @@map("sla_targets")
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(100)
  value     Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}
